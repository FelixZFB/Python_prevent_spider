# 9 代理
## 9.1 代理的基本原理
- 代理服务器，英文叫作 proxy server，它的功能是代理网络用户去获取网络信息。
    - 形象地说，它是网络信息的中转站。
    - 在我们正常请求一个网站时，是发送了请求给 Web 服务器，Web 服务器把响应传回给我们。
    - 如果设置了代理服务器，实际上就是在本机和服务器之间搭建了一个桥，
    - 此时本机不是直接向 Web 服务器发起请求，而是向代理服务器发出请求，
    - 请求会发送给代理服务器，然后由代理服务器再发送给 Web 服务器，
    - 接着由代理服务器再把 Web 服务器返回的响应转发给本机。
    - 这样我们同样可以正常访问网页，但这个过程中 Web 服务器识别出的真实 IP 就不再是我们本机的 IP 了，
    - 就成功实现了 IP 伪装，这就是代理的基本原理。
    
## 9.2 代理的作用
- 代理有什么作用呢？主要作用如下：
    - 突破自身 IP 访问限制，访问一些平时不能访问的站点。
    - 访问一些单位或团体内部资源
        - 如使用教育网内地址段免费代理服务器，
        - 就可以用于对教育网开放的各类 FTP 下载上传，以及各类资料查询共享等服务。
    - 提高访问速度，
        - 通常代理服务器都设置一个较大的硬盘缓冲区，当有外界的信息通过时，
        - 也将其保存到缓冲区中，当其他用户再访问相同的信息时， 
        - 则直接由缓冲区中取出信息，传给用户，以提高访问速度。
    - 隐藏真实 IP，
        - 上网者也可以通过这种方法隐藏自己的 IP，免受攻击，
        - 对于爬虫来说，我们用代理就是为了隐藏自身 IP，防止自身的 IP 被封锁。
    
## 9.3 爬虫代理
- 对于爬虫来说，由于爬虫爬取速度过快，在爬取过程中可能遇到同一个 IP 访问过于频繁的问题，
- 此时网站就会让我们输入验证码登录或者直接封锁 IP，这样会给爬取带来极大的不便。
- 使用代理隐藏真实的 IP，让服务器误以为是代理服务器在请求自己。
- 这样在爬取过程中通过不断更换代理，就不会被封锁，可以达到很好的爬取效果。

## 9.4 代理分类及常见类型
- 根据协议区分，代理可以分为如下类别：
    - FTP 代理服务器，主要用于访问 FTP 服务器，一般有上传、下载以及缓存功能，端口一般为 21、2121 等。
    - HTTP 代理服务器，主要用于访问网页，一般有内容过滤和缓存功能，端口一般为 80、8080、3128 等。
    - SSL/TLS 代理，主要用于访问加密网站，一般有 SSL 或 TLS 加密功能（最高支持 128 位加密强度），端口一般为 443。
    - RTSP 代理，主要用于 Realplayer 访问 Real 流媒体服务器，一般有缓存功能，端口一般为 554。
    - Telnet 代理，主要用于 telnet 远程控制（黑客入侵计算机时常用于隐藏身份），端口一般为 23。
    - POP3/SMTP 代理，主要用于 POP3/SMTP 方式收发邮件，一般有缓存功能，端口一般为 110/25。
    - SOCKS 代理，只是单纯传递数据包，不关心具体协议和用法，所以速度快很多，一般有缓存功能，端口一般为 1080。
    - SOCKS 代理协议又分为 SOCKS4 和 SOCKS5，SOCKS4 协议只支持 TCP，而 SOCKS5 协议支持 TCP 和 UDP，还支持各种身份验证机制、服务器端域名解析等。简单来说，SOCK4 能做到的 SOCKS5 都可以做到，但 SOCKS5 能做到的 SOCK4 不一定能做到。

- 根据代理的匿名程度，代理可以分为如下类别。
    - 高度匿名代理，高度匿名代理会将数据包原封不动的转发，在服务端看来就好像真的是一个普通客户端在访问，而记录的 IP 是代理服务器的 IP。
    - 普通匿名代理，普通匿名代理会在数据包上做一些改动，服务端上有可能发现这是个代理服务器，也有一定几率追查到客户端的真实 IP。代理服务器通常会加入的 HTTP 头有 HTTP_VIA 和 HTTP_X_FORWARDED_FOR。
    - 透明代理，透明代理不但改动了数据包，还会告诉服务器客户端的真实 IP。这种代理除了能用缓存技术提高浏览速度，能用内容过滤提高安全性之外，并无其他显著作用，最常见的例子是内网中的硬件防火墙。
    - 间谍代理，间谍代理指组织或个人创建的，用于记录用户传输的数据，然后进行研究、监控等目的的代理服务器。

- 常见代理类型
    - 使用网上的免费代理，最好使用高匿代理，使用前抓取下来筛选一下可用代理，也可以进一步维护一个代理池。
    - 使用付费代理服务，互联网上存在许多代理商，可以付费使用，质量比免费代理好很多。
    - ADSL 拨号，拨一次号换一次 IP，稳定性高，也是一种比较有效的解决方案。
    - 蜂窝代理，即用 4G 或 5G 网卡等制作的代理，由于蜂窝网络用作代理的情形较少，因此整体被封锁的几率会较低，但搭建蜂窝代理的成本较高

## 9.5 requests 使用代理
- 使用 HTTP 代理
    - 一个字典的形式就设置好了 HTTP 代理，它分为两个类别，有 HTTP 和 HTTPS，
    - 如果我们访问的链接是 HTTP 协议，那就用 http 字典名指定的代理，
    - 如果是 HTTPS 协议，那就用 https 字典名指定的代理。
    - 参考案例001/002

- 使用 SOCKS 代理
    - 安装一个包，这个包叫作 requests[socks]，安装命令如下所示：
    - 复制pip3 install "requests[socks]"
    - 参考案例003

## 9.6 Selenium 设置代理
- selenium 使用http和socks5代理
    - 参考案例004/005

- selenium 使用认证的http代理
    - 需要在本地创建一个 manifest.json 配置文件和 background.js 脚本来设置认证代理。
    - 运行案例代码之后本地会生成一个 proxy_auth_plugin.zip 文件来保存当前配置。
    - 参考案例006
    
## 9.7 aiohttp 设置代理
- 使用 http 代理
    - 用法和requests一样，参考案例007

- 使用 SOCKS 代理，我们需要安装一个支持库，叫作 aiohttp-socks，安装命令如下：
    - pip3 install aiohttp-socks
    - 参考案例008


### 代理池查看IP_Proxy_Pool_2020项目
###

