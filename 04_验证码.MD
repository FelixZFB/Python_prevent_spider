# 7 验证码
- 验证码介绍
    - 验证码，全称叫作 Completely Automated Public Turing test to tell Computers and Humans Apart，
    - 意思是全自动区分计算机和人类的图灵测试，取了它们关键词的首字母变成了 CAPTCHA，
    - 它是一种用来区分用户是计算机还是人的公共全自动程序。

- 验证码用途
    - 网站注册的时候加上验证码，可以一定程度上防止恶意大批量注册。
    - 网站登录的时候加上验证码，可以一定程度上防止恶意密码爆破。
    - 网站在发表评论的时候加上验证码，可以在一定程度上防止恶意灌水。
    - 网站在投票的时候加上验证码，可以在一定程度上防止恶意刷票。
    - 网站在被频繁访问的时候或者浏览行为不正常的时候，一般可能是遇到了爬虫，可以一定程度上防止爬虫的爬取。

- 验证码机制：
    - 对于图形验证码：
        - 比如字符验证码、计算型验证码
        - 服务器会把图形(使用绘图库 PIL 或 Canvas 随机绘制的图形验证码)的内容保存到 Session，然后将验证码图返回或者客户端自行显示，
        - 等用户提交表单之后校验 Session 里验证码的值和用户提交的值。
    - 对于行为验证码
        - 滑动验证码、滑动拼图验证码、点选文字验证码、鼠标轨迹检测
        - 服务器会做一些计算，把一些 Key、Token 等信息也储存在 Session 里面，
        - 用户首先要完成客户端的校验，如果校验成功才能提交表单，当客户端的校验完成之后，
        - 客户端会把验证之后计算产生的 Key、Token、Code 等信息发送到服务端，
        - 服务端会再做一次校验，如果服务端也校验通过了，那就算真正的通过了。
    - 对于手机验证码
        - 服务器会预先生成一个验证码的信息，然后会把这个验证码的结果还有要发送的手机号发送给短信发送服务商，
        - 让服务商下发验证码给用户，用户再把这个码提交给服务器，
        - 服务器判断 Session 里面的验证码和提交的验证码是否一致即可。

- 图形文字行为验证码识别方案：
    - 打码平台
        - 这里面很多验证码都是与坐标相关的，我们可以直接将验证码截图发送给打码平台，
        - 打码平台背后会有人帮我们找到对应的位置坐标，获取位置坐标之后就可以来模拟了。
        - 这时候模拟的方法有两种，一种是模拟行为，使用 Selenium 等实现，模拟完成之后通常能登录或者解锁某个 Session 封锁状态，获取有效 Cookies 即可。
        - 另一种是在 JavaScript 层级上模拟，这种难度更高，模拟完了可以直接获取验证码提交的一些 Token 值等内容。
    - 深度学习
        - 利用一些图像标注加深度学习的方法同样可以识别验证码，其实主要还是识别位置，
        - 有了位置之后同样可以模拟。

- 短信、扫码验证码解决方案：
    - 另外我们可能遇到一些类似短信、扫码的验证码，这种操作起来就会更加麻烦，一些解决思路如下：
    - 手机号可以不用自己的，可以从某些平台来获取，平台维护了一套手机短信收发系统，填入手机号，并通过 API 获取短信验证码即可。
    - 另外也可以购买一些专业的收码设备或者安装一些监听短信的软件，它会有一些机制把一些手机短信信息导出到某个接口或文本或数据库，然后再提取即可。
    - 对于扫码验证的情况，如果不用自己的账号，可以把码发送到打码平台，让对方用自己的账号扫码处理，但这种情况多数需要定制，可以去跟平台沟通。
    - 另外的方案就涉及到逆向和破解相关的内容了，一般需要逆向手机 App 内的扫码和解析逻辑，然后再模拟，这里就不再展开讲了。


## 7.1 字符验证码
- 特征：图片上面绘制的数字或者字母，底色有混淆图案
- 思路：
    - selenium等渲染工具保存验证码截图
    - pytesseract等OCR识别工具识别
- PyTesseract识别工具
    - 缺点：pytesseract识别率较低，识别不出来就没有任何结果
    - 即使进行二值化和灰度处理，很多还是无法识别
    - 使用腾讯云的ocr识别，还是有些无法识别
- 复杂验证码识别：
    - 使用卷积神经网络预测验证码：常用框架TensorFlow、PyTorch、Caffe
    - 先学习大量验证码图片，然后最终识别率可以达到99%以上
- 安考案例001

## 7.2 计算型验证码
- 特征：计算两个数字的加减乘计算得到结果
- 思路
    - selenium或者其它自动化渲染工具对指定元素进行截图
    - pytesseract识别图片为字符串
    - re正则查找数字和计算符号，然后计算结果
    - 然后向输入框输入结果最后点击登录
- 参考案例002

- selenium下对指定元素进行截图
```python
from selenium import webdriver
driver = webdriver.Chrome()
driver.maximize_window() # 最大化窗口
driver.get("https://www.autohome.com.cn")
 
driver.save_screenshot('capture.png')    #全屏截图

ele = driver.find_element_by_id('s4612')
ele.screenshot('ele.png')    #元素截图
```

## 7.3 滑动验证码
- 特征：滑块的滑动路线和滑动距离都是固定的
- 思路
    - selenium打开浏览器
    - 定位滑块和滑轨元素
    - 获取元素css属性的width值，计算滑动距离
    - 使用ActionChains模块滑动滑块到目标位置
    - 验证完成
- 参考案例003

## 7.4 滑动拼图验证码
- 特征：一个方块滑动到一个缺口完成拼图，一般都是水平向右滑动，
    - 但是滑块起始位置和终点位置是随机出现的
    - 滑动轨道和滑动距离都是随机的
- 滑动拼图实现1：
    - 按下滑块，缺口图形和缺口模块的style样式添加left属性值
    - 通过left属性值计算出滑动距离
- 滑动拼图实现2：
    - 缺口不是通过CSS或者style样式设置的，而是Canvas绘制的整个图片
    - 该缺口没有具体的属性值，就需要截取缺口出现前后的两张图片
    - 通过对比图片找出缺口的四个角的坐标位置，然后计算出来移动的距离
    - 可以移动的小图是有属性的，只是缺口图是绘制的
- 参考004/005案例

## 7.5 点选文字验证码
- 点选文字一般都是生僻字繁体字
- OCR识别率都较低
- 需要使用深度学习模块，大量学习后识别

## 7.6 鼠标轨迹检测
- 网页可以纪录鼠标轨迹，鼠标每移动一个像素就会纪录一次坐标值
- selenium模拟鼠标移动，轨需要使用操作大量移动，鼠标移动次数要超过两点之间最短距离的鼠标纪录次数


